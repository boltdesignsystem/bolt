sudo: false
dist: trusty

language: php
php:
  - 7.1

addons:
  sauce_connect: true
  # apt:
  #   sources:
  #   - ubuntu-toolchain-r-test
  #   packages:
  #   - g++-4.8
  #   - graphicsmagick

before_install:
- nvm install # version lifted from `.nvmrc`
- curl -o- -L https://yarnpkg.com/install.sh | bash -s -- --version 1.6.0
- export PATH="$HOME/.yarn/bin:$PATH"
# yarn install
# - node --version && npm --version && yarn --version && composer --version
# - composer global require hirak/prestissimo
# - if [[ -n "$GITHUB_TOKEN" ]]; then composer config -g github-oauth.github.com ${GITHUB_TOKEN};
  # fi;

before_script:
- phpenv config-rm xdebug.ini

install:
# - npm run setup
- yarn
- yarn global add nightwatch
- npm run bootstrap
- npm run composer
# yarn && npm run bootstrap && npm run composer
# - npm run composer:pl

# before_script:
# - npm run lint
# - npm test

jobs:
  include:
    - stage: testing, build and deploy
      script: npm run lint
      script: npm run test
      script: travis_wait npm run build:pl && npm run build:bolt-site && npm run deploy
    #   script: npm run 
    # - stage: deploy
    #   script: npm run deploy
    # - stage: prepare cache
    #   script: true

# Can't do deploy on `after_success` b/c if deploy fails, the build still reports success. Can't use `deploy` step b/c Travis skips that on PRs.
# script:
# - time bash ./travis.sh
#- nightwatch --config nightwatch.js --env chrome,ie11

# after_success: # Warning: this fires after a build is already marked as successful so failing this will not fail the build.
#   - git status # Just want to check

cache:
  apt: true
  yarn: true
  directories:
    - $HOME/.composer/cache/files
    #- node_modules
    #- $HOME/.cache/yarn
    # - $HOME/.composer
    # - apps/pattern-lab/vendor
    #- apps/drupal-lab/vendor
    # - apps/drupal-lab/web/core
    # - apps/bolt-site/vendor
    # - packages/core-php/vendor
    #- apps/pw-site/vendor

notifications:
  email:
    on_success: never
    on_failure: always
  slack:
    secure: cNto+gWAoK1JM9jBNG4i4rMSybv3twMbqlFSCohQFBDMwKFMdlyWqFDX6iYKtHxWEDzrZyRz3qiJ8/S44mgjeKJ/xHbHDtPchp/KL2P1htipvwD2EZXobcBEGl83v2rmtFO1WNJUPB3RIJE2yt1wJsX7NIXpDw82hePmaIvNJmtbLpK/J5uaFqGNHIsctmULgVmGSNSTyK4nYxxjNNLd0EvO37Y6VN8FhsKNu2NHMKeeQxinEvETDUh8XuqXZYNWE3PBvVa4OiDhgnr5K27jsnWX+wEmqg0xY+CMf7mUSTqVN61fA7LnHyM0qcGGmB6YTv4QYLMwPydp+nsjDcm3St9D+KOTsQ4ExOaEAL/6EnAEpl8GtxST+ytdqswhCC4yMCO61Hy+M5AoXgDSGrrXHgZakDMAcEVcJdH38791hRxcuM3ldVmHAlAWFdgRLG5rRMVh3qoXz7jbraoTdjyKMegQIQdKR2SX7O9Dv0EEtLz4lTFN2RENvAjLggUPPU+ESoUHmSbwmPGnt7jy3ra2AI3nnYpfn/0e6Op/A3z7HLbdm3XyuNWoTPhy1mc4Adca+HosJ37UPv7nDRIGds1sKYAeWq94+rEk+/6IQ/oRIDRhSYsQbLLWnU6DH4o7iOj7D+X/ngjqmF75nW2s5+7rtdBHFvNzOJalCKHiDTMfdlQ=

